# UDP 调试记录文档

## 1. 项目与版本信息

- **项目名称:** K7 UDP 高速通信
- **FPGA型号:** Xilinx Kintex-7
- **设计版本:** v1.0
- **记录日期:** 2025-06-26

## 2. 调试环境

| 配置项 | 参数 | 备注 |
| :--- | :--- | :--- |
| **硬件平台** | K7 开发板 | |
| **开发工具** | Vivado 2018.3 | |
| **仿真工具** | ModelSim / QuestaSim | |
| **上位机系统** | Windows 10 / Linux | |
| **网络分析** | Wireshark | 用于抓包分析 |
| **网络调试** | NetAssist (网络调试助手) | 用于收发UDP包 |
| **FPGA IP** | 192.168.1.10 | |
| **FPGA MAC** | `DE:AD:BE:EF:00:01` | |
| **FPGA UDP端口** | 8080 | |
| **PC IP** | 192.168.1.100 | |
| **PC UDP端口** | 8080 | |

## 3. 调试日志

| 日期/ID | 测试模块 | 测试目标 | 操作步骤 | 预期结果 | 实际结果 | 问题分析与定位 | 解决方案/下一步 | 状态 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 2025-06-26 | `udp_tx_path` | **基础UDP包发送** | 1. 编译工程, 下载bit文件至FPGA。<br>2. PC端打开Wireshark, 过滤器设置为 `ip.addr == 192.168.1.10`。<br>3. 按下开发板上的触发按键, 启动UDP发送逻辑。 | PC端Wireshark能抓取到来自FPGA的UDP包,包的源/目IP、端口、数据内容均符合预期。 | Wireshark未抓到任何UDP包。PHY灯状态正常。 | 1. **物理层检查**: PHY芯片工作状态未知。<br>2. **MAC层检查**: `eth_mac` 是否成功发送数据帧？<br>3. **IP/UDP层检查**: `udp_tx_path` 模块是否收到了上层应用数据并正确封装？ | 1. **添加ILA**: 在 `eth_mac` 的 `gmii_txd`, `gmii_tx_en` 信号上添加ILA探针, 观察是否有数据发出。<br>2. **仿真**: 对 `udp_tx_path` 进行模块级仿真, 验证其封装逻辑。 | **进行中** |
| | `udp_rx_path` | **基础UDP包接收** | 1. FPGA运行正常。<br>2. PC端使用NetAssist向FPGA的IP和端口发送指定内容的UDP包。<br>3. 观察FPGA板上与接收状态相关的LED灯。 | 接收状态LED灯闪烁, 表示FPGA已收到数据。 | LED无任何变化。 | 1. **ARP解析**: FPGA是否能正确响应PC的ARP请求？<br>2. **FCS校验**: `axis_eth_fcs_check` 模块是否因校验错误而丢弃了数据包？<br>3. **IP/UDP过滤**: `udp_demux` 模块是否因为IP或端口不匹配而丢包？ | 1. **Wireshark检查**: 确认FPGA是否对PC的ARP请求做出了响应。<br>2. **添加ILA**: 在 `udp_rx_path` 的输出端 `m_axis_udp_rx_...` 信号上添加探针, 确认是否有数据解包出来。 | **待开始** |
| 2025-06-26 | `top` | udp误码率 | 1、利用开发板上的按键进行触发，每秒1次，每50个时钟生成一个数据，每100个数据生成一个last信号（表示包结束） | 按一次按键，上位机应该收到25k个包 | 只收到了一个包就结束了 | 生成last的逻辑有问题 | | 进行中 |
| 2025-06-26 | `top` | udp误码率 | | | | | | |


## 4. 关键问题与总结

- **问题1: PHY芯片初始化失败**
  - **现象:** 相同的程序，黑金开发板的phy芯片正常，ptrw022异常。两者芯片有差异，前者是，后者是RTL8211FI-CG
  - **解决方案:** RTL8211FI-CG数据手册中特别对复位时间做了说明，需要至少20ms时间，且复位后需要30ms等待。所以增加一个上位机延时模块，对phy进行复位。

- **问题2: ...**
  - **现象:** ...
  - **解决方案:** ...


## 5. 附录与参考

- **相关代码:**
  - [rtl/udp_tx_path.v](./rtl/udp_tx_path.v)
  - [rtl/udp_rx_path.v](./rtl/udp_rx_path.v)
  - [sim/sub1-udp_tx_path/](./sim/sub1-udp_tx_path/)
- **仿真波形:**
  
  - `sim/waveforms/tx_path_wave.png`
- **抓包文件:**

  ![](./doc/image/udp_wireshark_1.png)

